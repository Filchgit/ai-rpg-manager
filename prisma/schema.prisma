// Prisma schema for AI RPG Manager

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  worldSettings String? @db.Text
  aiGuidelines String? @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sessions    Session[]
  characters  Character[]
  knowledge   CampaignKnowledge[]
  toneProfiles ToneProfile[]
  mechanicsRules MechanicsRule[]
  costSnapshots SessionCostSnapshot[]
  costAggregate CampaignCostAggregate?
  
  @@index([createdAt])
}

model Session {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  status      SessionStatus @default(ACTIVE)
  notes       String?  @db.Text
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages    Message[]
  state       SessionState?
  summaries   SessionSummary[]
  
  @@index([campaignId])
  @@index([status])
  @@index([startedAt])
}

enum SessionStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

model Character {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  race        String?
  class       String?
  level       Int      @default(1)
  stats       Json?    // Store character stats as JSON (STR, DEX, CON, INT, WIS, CHA)
  backstory   String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
}

model Message {
  id          String   @id @default(cuid())
  sessionId   String
  role        MessageRole
  content     String   @db.Text
  tokenCount  Int?
  metadata    Json?    // Store additional metadata (prompt tokens, completion tokens, etc.)
  createdAt   DateTime @default(now())
  
  session     Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([createdAt])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model RateLimit {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  requestCount Int     @default(0)
  tokenCount  Int      @default(0)
  windowStart DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([sessionId])
  @@index([windowStart])
}

model SessionState {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  currentLocation String?
  activeNPCs      Json?    // Array of NPC names/descriptions currently in scene
  ongoingQuests   Json?    // Array of active quest objectives
  partyConditions Json?    // Health, status effects, inventory highlights
  recentEvents    Json?    // Last 3-5 significant events for quick context
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
}

model SessionSummary {
  id              String   @id @default(cuid())
  sessionId       String
  messageRangeStart Int    // Starting message number this summary covers
  messageRangeEnd   Int    // Ending message number this summary covers
  summary         String   @db.Text
  keyEvents       Json?    // Structured key events (dice rolls, combat results, decisions)
  createdAt       DateTime @default(now())
  
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([messageRangeEnd])
}

model CampaignKnowledge {
  id          String   @id @default(cuid())
  campaignId  String
  category    KnowledgeCategory
  title       String
  content     String   @db.Text
  keywords    Json?    // Array of keywords for matching
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
  @@index([category])
}

enum KnowledgeCategory {
  LOCATION
  NPC
  ITEM
  LORE
  FACTION
  QUEST
  OTHER
}

model ToneProfile {
  id          String   @id @default(cuid())
  campaignId  String
  name        String
  description String?
  conditions  Json?    // When to apply this tone (e.g., character present, location type)
  toneRules   String   @db.Text  // Instructions for AI tone/style
  priority    Int      @default(0)  // Higher priority profiles override lower ones
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
  @@index([priority])
}

model MechanicsRule {
  id          String   @id @default(cuid())
  campaignId  String
  category    MechanicsCategory
  title       String
  content     String   @db.Text
  keywords    Json?    // Keywords that trigger including this rule
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
  @@index([category])
}

enum MechanicsCategory {
  COMBAT
  SKILL_CHECK
  MAGIC
  SOCIAL
  EXPLORATION
  REST
  OTHER
}

// Persistent cost tracking that survives session/campaign deletion
model SessionCostSnapshot {
  id                  String   @id @default(cuid())
  sessionId           String?  @unique // Nullable to allow session deletion
  campaignId          String
  sessionName         String
  totalMessages       Int      @default(0)
  totalTokens         Int      @default(0)
  promptTokens        Int      @default(0)
  completionTokens    Int      @default(0)
  totalCost           Decimal  @db.Decimal(10, 6)
  sessionStartedAt    DateTime
  sessionEndedAt      DateTime?
  lastUpdated         DateTime @updatedAt
  createdAt           DateTime @default(now())
  
  campaign            Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
  @@index([sessionId])
  @@index([sessionStartedAt])
}

model CampaignCostAggregate {
  id                  String   @id @default(cuid())
  campaignId          String   @unique
  totalSessions       Int      @default(0)
  totalMessages       Int      @default(0)
  totalTokens         Int      @default(0)
  totalCost           Decimal  @db.Decimal(10, 6) @default(0)
  lastUpdated         DateTime @updatedAt
  createdAt           DateTime @default(now())
  
  campaign            Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@index([campaignId])
}

